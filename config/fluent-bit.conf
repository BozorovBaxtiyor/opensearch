# =============================================
# fluent-bit.conf – YAXSHILANGAN VERSIYA (2025)
# =============================================

[SERVICE]
    Flush         30
    Daemon        Off
    Log_Level     debug
    Grace         5
    Parsers_File  parsers.conf

# =============================================
# Umumiy metadata – har bir logga qo'shiladi
# =============================================
[FILTER]
    Name          modify
    Match         *
    Add           log_host ${HOSTNAME}
    Add           env production
    Add           cluster my-cluster-name

# =============================================
# INPUTS – Log manbalari
# =============================================

# 1. NGINX Access Logs
[INPUT]
    Name              tail
    Tag               nginx.access
    Path              /var/log/nginx/access.log
    Parser            nginx_access
    Read_From_Head    False
    Mem_Buf_Limit     10MB
    Skip_Long_Lines   On

# 2. Syslog
[INPUT]
    Name              tail
    Tag               system.syslog
    Path              /var/log/syslog
    Parser            syslog_rfc3164
    Read_From_Head    False
    Mem_Buf_Limit     5MB

# 3. SSH / Auth logs
[INPUT]
    Name              tail
    Tag               security.auth
    Path              /var/log/auth.log
    Parser            syslog_auth
    Read_From_Head    False
    Mem_Buf_Limit     5MB

# 4. Docker container logs (json-file driver)
[INPUT]
    Name              tail
    Tag               container.docker
    Path              /var/lib/docker/containers/*/*-json.log
    Parser            docker_json
    Mem_Buf_Limit     20MB
    Skip_Long_Lines   On
    Read_From_Head    False
#   DB                /var/lib/fluent-bit/docker-pos.db   # pozitsiyani saqlash uchun

# 5. Custom Application JSON logs
[INPUT]
    Name              tail
    Tag               app.custom
    Path              /var/log/app/custom_json.log
    Parser            app_json
    Read_From_Head    False
    Mem_Buf_Limit     10MB

# 6. Systemd/Journald (faqat kerakli unitlar, masalan docker, kubelet va b.)
[INPUT]
    Name              systemd
    Tag               system.journald
    Systemd_Filter    _SYSTEMD_UNIT=docker.service
    Read_From_Tail    On
    Max_Entries       200
    Strip_Underscores On

# =============================================
# THROTTLING – journald juda ko'p yozishi mumkin
# =============================================
[FILTER]
    Name        throttle
    Match       system.journald
    Rate        500
    Window      1
    Interval    1s

# =============================================
# OUTPUTS – Har bir log turi alohida indeksga!
# Kunlik indeks + ILM uchun ideal
# =============================================

# 1. NGINX
[OUTPUT]
    Name              opensearch
    Match             nginx.*
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    Index             logs-nginx-%Y.%m.%d
    Type              _doc
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASS}
    Suppress_Type_Name On
    Buffer_Size       256k
    Retry_Limit       3
    tls               On
    tls.verify        Off

# 2. System Syslog
[OUTPUT]
    Name              opensearch
    Match             system.syslog
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    Index             logs-syslog-%Y.%m.%d
    Type              _doc
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASS}
    Suppress_Type_Name On
    Buffer_Size       256k
    Retry_Limit       3
    tls               On
    tls.verify        Off

# 3. Security / Auth / SSH
[OUTPUT]
    Name              opensearch
    Match             security.*
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    Index             logs-security-%Y.%m.%d
    Type              _doc
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASS}
    Suppress_Type_Name On
    Buffer_Size       256k
    Retry_Limit       3
    tls               On
    tls.verify        Off

# 4. Docker Containers
[OUTPUT]
    Name              opensearch
    Match             container.*
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    Index             logs-docker-%Y.%m.%d
    Type              _doc
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASS}
    Suppress_Type_Name On
    Buffer_Size       512k
    Retry_Limit       3
    tls               On
    tls.verify        Off

# 5. Custom Application
[OUTPUT]
    Name              opensearch
    Match             app.*
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    Index             logs-application-%Y.%m.%d
    Type              _doc
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASS}
    Suppress_Type_Name On
    Buffer_Size       256k
    Retry_Limit       3
    tls               On
    tls.verify        Off

# 6. Journald / Systemd
[OUTPUT]
    Name              opensearch
    Match             system.journald
    Host              ${OPENSEARCH_HOST}
    Port              ${OPENSEARCH_PORT}
    Index             logs-journald-%Y.%m.%d
    Type              _doc
    HTTP_User         ${OPENSEARCH_USER}
    HTTP_Passwd       ${OPENSEARCH_PASS}
    Suppress_Type_Name On
    Buffer_Size       256k
    Retry_Limit       3
    tls               On
    tls.verify        Off